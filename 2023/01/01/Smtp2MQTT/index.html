<html lang="en"><head><link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.0/cookieconsent.min.css"></head><body><x_layout_ejs">
  
  

  <x_partial_head_ejs>

  
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Tachyons Core CSS -->
    <link rel="stylesheet" href="https://unpkg.com/tachyons@4.12.0/css/tachyons.min.css">

    <!-- Custom Fonts -->
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">

    <!-- Custom CSS -->
    
<link rel="stylesheet" href="/css/style.css">

  <meta name="generator" content="Hexo 6.3.0">
</x_partial_head_ejs>

  

    <x_post_ejs>
   <!-- Banner -->
   <x_partial_banner_ejs>
   <div class="w-100 bg-banner ph5-ns ph3 text-light mb4">

      <nav class="db dt-l w-100 mw10 center border-box pv3">
         <div class="db dtc-l v-mid w-100 w-75-l tc tr-l">
            
            <a class="link dim f6 f5-l dib mr3 mr4-l white" href="/" title="Home">
               Home
            </a>
            
         </div>
      </nav>

      <!-- Title -->
      <div class="w-100 mw10 center vh-20 dt">
         <div class="dtc v-mid white">
            <h1 class="f1-l f2-m tc tc-m tl-ns mv0">My Digital Garden</h1>
            <p class="ma0 pb3 f4 fw3 tc tc-m tl-ns">Digital Garden of Horst Fleischer</p>
         </div>
      </div>
   </div>
</x_partial_banner_ejs>

   <!-- Content -->
   <div class="w-100 ph2 ph4-m ph5-l">
      <div class="content">
         <div class="fl w-100 w-80-l mw9 left pr4-ns pr0-m mb4 br-l b--light-gray post-content">
            <h1>
               Smtp2MQTT
            </h1>
            <div>
               Save Mail in Filesystem and forward notification with reference via MQTT
            </div>
            <!-- Main Post Content -->
            <h1 id="References"><a href="#References" class="headerlink" title="References"></a>References</h1><p><a target="_blank" rel="noopener" href="https://nodemailer.com/extras/smtp-server/">https://nodemailer.com/extras/smtp-server/</a><br><a target="_blank" rel="noopener" href="https://github.com/trentm/node-bunyan">https://github.com/trentm/node-bunyan</a><br><a target="_blank" rel="noopener" href="http://www.steves-internet-guide.com/using-node-mqtt-client/">http://www.steves-internet-guide.com/using-node-mqtt-client/</a><br><a target="_blank" rel="noopener" href="https://nodejs.org/en/docs/guides/nodejs-docker-webapp/">https://nodejs.org/en/docs/guides/nodejs-docker-webapp/</a></p>
<h1 id="File-tsconfig-json"><a href="#File-tsconfig-json" class="headerlink" title="File tsconfig.json"></a>File tsconfig.json</h1><figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">{</span></span><br><span class="line">&nbsp; <span class="attr">"compilerOptions"</span><span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">&nbsp; &nbsp; <span class="attr">"module"</span><span class="punctuation">:</span> <span class="string">"commonjs"</span><span class="punctuation">,</span></span><br><span class="line">&nbsp; &nbsp; <span class="attr">"esModuleInterop"</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">&nbsp; &nbsp; <span class="attr">"target"</span><span class="punctuation">:</span> <span class="string">"es6"</span><span class="punctuation">,</span></span><br><span class="line">&nbsp; &nbsp; <span class="attr">"moduleResolution"</span><span class="punctuation">:</span> <span class="string">"node"</span><span class="punctuation">,</span></span><br><span class="line">&nbsp; &nbsp; <span class="attr">"sourceMap"</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">&nbsp; &nbsp; <span class="attr">"outDir"</span><span class="punctuation">:</span> <span class="string">"dist"</span></span><br><span class="line">&nbsp; <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">&nbsp; <span class="attr">"lib"</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">"es2015"</span><span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">}</span></span><br></pre></td></tr></tbody></table></figure>

<h1 id="File-package-json"><a href="#File-package-json" class="headerlink" title="File  package.json"></a>File  package.json</h1><figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">{</span></span><br><span class="line">&nbsp; <span class="attr">"name"</span><span class="punctuation">:</span> <span class="string">"smtp2mqtt"</span><span class="punctuation">,</span></span><br><span class="line">&nbsp; <span class="attr">"version"</span><span class="punctuation">:</span> <span class="string">"1.0.0"</span><span class="punctuation">,</span></span><br><span class="line">&nbsp; <span class="attr">"description"</span><span class="punctuation">:</span> <span class="string">""</span><span class="punctuation">,</span></span><br><span class="line">&nbsp; <span class="attr">"main"</span><span class="punctuation">:</span> <span class="string">"./dist/smtp2mqtt.js"</span><span class="punctuation">,</span></span><br><span class="line">&nbsp; <span class="attr">"scripts"</span><span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">&nbsp; &nbsp; <span class="attr">"buildImage"</span><span class="punctuation">:</span> <span class="string">"docker build . -t smtp2mqtt"</span><span class="punctuation">,</span></span><br><span class="line">&nbsp; &nbsp; <span class="attr">"build"</span><span class="punctuation">:</span> <span class="string">"npx tsc"</span><span class="punctuation">,</span></span><br><span class="line">&nbsp; &nbsp; <span class="attr">"smtp2mqtt"</span><span class="punctuation">:</span> <span class="string">"node ./dist/smtp2mqtt.js"</span></span><br><span class="line">&nbsp; <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">&nbsp; <span class="attr">"author"</span><span class="punctuation">:</span> <span class="string">""</span><span class="punctuation">,</span></span><br><span class="line">&nbsp; <span class="attr">"license"</span><span class="punctuation">:</span> <span class="string">"ISC"</span><span class="punctuation">,</span></span><br><span class="line">&nbsp; <span class="attr">"devDependencies"</span><span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">&nbsp; &nbsp; <span class="attr">"@types/express"</span><span class="punctuation">:</span> <span class="string">"^4.17.15"</span><span class="punctuation">,</span></span><br><span class="line">&nbsp; &nbsp; <span class="attr">"typescript"</span><span class="punctuation">:</span> <span class="string">"^4.9.4"</span></span><br><span class="line">&nbsp; <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">&nbsp; <span class="attr">"dependencies"</span><span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">&nbsp; &nbsp; <span class="attr">"@types/bunyan"</span><span class="punctuation">:</span> <span class="string">"^1.8.8"</span><span class="punctuation">,</span></span><br><span class="line">&nbsp; &nbsp; <span class="attr">"@types/nodemailer"</span><span class="punctuation">:</span> <span class="string">"^6.4.7"</span><span class="punctuation">,</span></span><br><span class="line">&nbsp; &nbsp; <span class="attr">"bunyan"</span><span class="punctuation">:</span> <span class="string">"^1.8.15"</span><span class="punctuation">,</span></span><br><span class="line">&nbsp; &nbsp; <span class="attr">"mailparser"</span><span class="punctuation">:</span> <span class="string">"^3.1.0"</span><span class="punctuation">,</span></span><br><span class="line">&nbsp; &nbsp; <span class="attr">"mqtt"</span><span class="punctuation">:</span> <span class="string">"^4.3.7"</span><span class="punctuation">,</span></span><br><span class="line">&nbsp; &nbsp; <span class="attr">"smtp-server"</span><span class="punctuation">:</span> <span class="string">"^3.8.0"</span></span><br><span class="line">&nbsp; <span class="punctuation">}</span></span><br><span class="line"><span class="punctuation">}</span></span><br></pre></td></tr></tbody></table></figure>

<h1 id="Dockerfile"><a href="#Dockerfile" class="headerlink" title="Dockerfile"></a>Dockerfile</h1><figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">FROM</span> <span class="string">node:19.3.0-alpine3.16</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Create app directory</span></span><br><span class="line"><span class="string">WORKDIR</span> <span class="string">/smtp2mqtt</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Install app dependencies</span></span><br><span class="line"><span class="comment"># A wildcard is used to ensure both package.json AND package-lock.json are copied</span></span><br><span class="line"><span class="comment"># where available (npm@5+)</span></span><br><span class="line"><span class="string">COPY</span> <span class="string">package*.json</span> <span class="string">./</span></span><br><span class="line"></span><br><span class="line"><span class="string">RUN</span> <span class="string">npm</span> <span class="string">install</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># If you are building your code for production</span></span><br><span class="line"><span class="comment"># RUN npm ci --only=production</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Bundle app source</span></span><br><span class="line"><span class="string">COPY</span> <span class="string">./dist/smtp2mqtt.js</span> <span class="string">.</span></span><br><span class="line"></span><br><span class="line"><span class="string">EXPOSE</span> <span class="number">3001</span></span><br><span class="line"></span><br><span class="line"><span class="string">CMD</span> [ <span class="string">"node"</span>, <span class="string">"/smtp2mqtt/smtp2mqtt.js"</span> ]</span><br></pre></td></tr></tbody></table></figure>

<h1 id="Generate-Javascript-from-Typescript"><a href="#Generate-Javascript-from-Typescript" class="headerlink" title="Generate Javascript from Typescript"></a>Generate Javascript from Typescript</h1><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm run build</span><br></pre></td></tr></tbody></table></figure>

<h1 id="Run-smtp2mqtt-js"><a href="#Run-smtp2mqtt-js" class="headerlink" title="Run smtp2mqtt.js"></a>Run smtp2mqtt.js</h1><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm run smtp2mqtt</span><br></pre></td></tr></tbody></table></figure>

<h1 id="Create-Docker-image"><a href="#Create-Docker-image" class="headerlink" title="Create Docker image"></a>Create Docker image</h1><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm run buildImage</span><br></pre></td></tr></tbody></table></figure>

<h1 id="Source-code-smtp2mqtt-ts"><a href="#Source-code-smtp2mqtt-ts" class="headerlink" title="Source code smtp2mqtt.ts"></a>Source code smtp2mqtt.ts</h1><figure class="highlight typescript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> { <span class="title class_">SMTPServer</span> } = <span class="built_in">require</span>(<span class="string">"smtp-server"</span>);</span><br><span class="line"><span class="keyword">const</span> { simpleParser } = <span class="built_in">require</span>(<span class="string">"mailparser"</span>);</span><br><span class="line"><span class="keyword">import</span> mqtt <span class="keyword">from</span> <span class="string">"mqtt"</span>;</span><br><span class="line"><span class="keyword">import</span> fs <span class="keyword">from</span> <span class="string">"fs"</span>;</span><br><span class="line"><span class="keyword">import</span> bunyan <span class="keyword">from</span> <span class="string">"bunyan"</span>;</span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">mapToObj</span>(<span class="params">inputMap</span>) {</span><br><span class="line">&nbsp; &nbsp;<span class="keyword">let</span> obj = {};</span><br><span class="line">&nbsp; &nbsp;inputMap.<span class="title function_">forEach</span>(<span class="keyword">function</span>(<span class="params">value, key</span>){</span><br><span class="line">&nbsp; &nbsp; &nbsp; &nbsp;obj[key] = value</span><br><span class="line">&nbsp; &nbsp;});</span><br><span class="line"></span><br><span class="line">&nbsp; &nbsp;<span class="keyword">return</span> obj;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">sessionInfoSerializer</span>(<span class="params">sessionInfo</span>) {</span><br><span class="line">  &nbsp;<span class="keyword">return</span> {</span><br><span class="line">&nbsp; &nbsp; &nbsp; <span class="attr">id</span>: sessionInfo.<span class="property">id</span>,</span><br><span class="line">&nbsp; &nbsp; &nbsp; remoteAddress : sessionInfo.<span class="property">remoteAddress</span>,</span><br><span class="line">&nbsp; &nbsp; &nbsp; clientHostname : sessionInfo.<span class="property">clientHostname</span>,</span><br><span class="line">&nbsp; &nbsp; &nbsp; transaction : sessionInfo.<span class="property">transaction</span></span><br><span class="line">&nbsp; &nbsp;};</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">parsedMailInfoSerializer</span>(<span class="params">parsedMailInfo</span>) {</span><br><span class="line">&nbsp; &nbsp;<span class="keyword">return</span> {</span><br><span class="line">&nbsp; &nbsp; &nbsp; <span class="attr">messageId</span>: parsedMailInfo.<span class="property">messageId</span>,</span><br><span class="line">&nbsp; &nbsp; &nbsp; <span class="attr">from</span>: parsedMailInfo.<span class="property">from</span>,</span><br><span class="line">&nbsp; &nbsp;};</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> logger = bunyan.<span class="title function_">createLogger</span>({</span><br><span class="line">&nbsp; &nbsp;<span class="attr">name</span>: <span class="string">"smtp2mqtt"</span>,</span><br><span class="line">&nbsp; &nbsp;<span class="attr">level</span>: <span class="string">"debug"</span>,</span><br><span class="line">&nbsp; &nbsp;<span class="attr">serializers</span>: {</span><br><span class="line">&nbsp; &nbsp; &nbsp; <span class="attr">sessionInfo</span>: sessionInfoSerializer,</span><br><span class="line">&nbsp; &nbsp; &nbsp; <span class="attr">parsedMailInfo</span>: parsedMailInfoSerializer</span><br><span class="line">&nbsp; &nbsp;}</span><br><span class="line">});</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> smtpStorage = <span class="string">"/storage"</span></span><br><span class="line"><span class="keyword">const</span> smtpServerPort = <span class="number">2525</span>;</span><br><span class="line"><span class="keyword">const</span> smtpUserName = <span class="string">"pi@fleishor.localdomain"</span>;</span><br><span class="line"><span class="keyword">const</span> smtpPassword = <span class="string">"pi"</span>;</span><br><span class="line"><span class="keyword">const</span> mqttBroker = <span class="string">"mqtt://docker.fritz.box"</span>;</span><br><span class="line"><span class="keyword">const</span> mqttClientId = <span class="string">"smtp2mqtt"</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Connect to MQTT Broker</span></span><br><span class="line"><span class="keyword">let</span> mqttClientConnected = <span class="literal">false</span>;</span><br><span class="line"><span class="keyword">const</span> mqttClient = mqtt.<span class="title function_">connect</span>(mqttBroker, { <span class="attr">clientId</span>: mqttClientId });</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> smtpServer = <span class="keyword">new</span> <span class="title class_">SMTPServer</span>({</span><br><span class="line">&nbsp; &nbsp;<span class="comment">// disable STARTTLS to allow authentication in clear text mode</span></span><br><span class="line">&nbsp; &nbsp;<span class="attr">disabledCommands</span>: [<span class="string">"STARTTLS"</span>],</span><br><span class="line">&nbsp; &nbsp;<span class="attr">logger</span>: logger,</span><br><span class="line">&nbsp; &nbsp;<span class="title function_">onConnect</span>(<span class="params">session, callback</span>) {</span><br><span class="line">&nbsp; &nbsp; &nbsp; logger.<span class="title function_">info</span>({<span class="attr">sessionInfo</span>: session}, <span class="string">"SMTPServer.onConnect from "</span> + session.<span class="property">clientHostname</span>);</span><br><span class="line">    &nbsp; <span class="keyword">return</span> <span class="title function_">callback</span>();</span><br><span class="line">&nbsp; &nbsp;},</span><br><span class="line">&nbsp; &nbsp;<span class="title function_">onClose</span>(<span class="params">session</span>) {</span><br><span class="line">&nbsp; &nbsp; &nbsp; logger.<span class="title function_">info</span>({<span class="attr">sessionInfo</span>: session}, <span class="string">"SMTPServer.onClose from "</span> + session.<span class="property">clientHostname</span>);</span><br><span class="line">&nbsp; &nbsp;},</span><br><span class="line">&nbsp; &nbsp;<span class="title function_">onData</span>(<span class="params">stream, session, callback</span>) {</span><br><span class="line">&nbsp; &nbsp; &nbsp; logger.<span class="title function_">info</span>({<span class="attr">sessionInfo</span>: session}, <span class="string">"SMTPServer.onData from "</span> + session.<span class="property">clientHostname</span>);</span><br><span class="line">&nbsp; &nbsp; &nbsp; <span class="title function_">simpleParser</span>(stream, {}, <span class="function">(<span class="params">err, parsedMail</span>) =&gt;</span> {</span><br><span class="line">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;logger.<span class="title function_">info</span>({<span class="attr">sessionInfo</span>: session, <span class="attr">parsedMailInfo</span>: parsedMail}, <span class="string">"SMTPServer.onData.simpleParser: start"</span>);</span><br><span class="line">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="keyword">if</span> (err)</span><br><span class="line">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;{</span><br><span class="line">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; logger.<span class="title function_">error</span>({<span class="attr">sessionInfo</span>: session}, <span class="string">"SMTPServer.onData.simpleParser: "</span> + err);</span><br><span class="line">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;}</span><br><span class="line"></span><br><span class="line">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;logger.<span class="title function_">info</span>({<span class="attr">sessionInfo</span>: session, <span class="attr">parsedMailInfo</span>: parsedMail}, <span class="string">"SMTPServer.onData.simpleParser: parsed email with subject: "</span> + parsedMail.<span class="property">subject</span>);</span><br><span class="line">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="keyword">var</span> parsedWithoutAttachments = <span class="title class_">Object</span>.<span class="title function_">assign</span>({}, parsedMail);;</span><br><span class="line">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="keyword">delete</span> parsedWithoutAttachments.<span class="property">attachments</span>;</span><br><span class="line">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;parsedWithoutAttachments.<span class="property">headers</span> = <span class="title function_">mapToObj</span>(parsedMail.<span class="property">headers</span>);</span><br><span class="line">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="keyword">if</span> (!parsedWithoutAttachments.<span class="property">html</span>)</span><br><span class="line">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;{</span><br><span class="line">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; logger.<span class="title function_">info</span>({<span class="attr">sessionInfo</span>: session, <span class="attr">parsedMailInfo</span>: parsedMail}, <span class="string">"SMTPServer.onData.simpleParser: replace html with testAsHtml"</span>);</span><br><span class="line">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; parsedWithoutAttachments.<span class="property">html</span> = parsedWithoutAttachments.<span class="property">textAsHtml</span>;</span><br><span class="line">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;}</span><br><span class="line">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;logger.<span class="title function_">info</span>({<span class="attr">sessionInfo</span>: session, <span class="attr">parsedMailInfo</span>: parsedMail}, <span class="string">"SMTPServer.onData.simpleParser: make directory for session.id"</span> + session.<span class="property">id</span>);</span><br><span class="line">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;fs.<span class="title function_">mkdirSync</span>(session.<span class="property">id</span>);</span><br><span class="line">  &nbsp; &nbsp; &nbsp; &nbsp;logger.<span class="title function_">info</span>({<span class="attr">sessionInfo</span>: session, <span class="attr">parsedMailInfo</span>: parsedMail}, <span class="string">"SMTPServer.onData.simpleParser: write JSON file"</span>);</span><br><span class="line">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;fs.<span class="title function_">writeFileSync</span>(session.<span class="property">id</span> + <span class="string">"/"</span> + session.<span class="property">id</span> + <span class="string">".json"</span>, <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(parsedWithoutAttachments));</span><br><span class="line">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;logger.<span class="title function_">info</span>({<span class="attr">sessionInfo</span>: session, <span class="attr">parsedMailInfo</span>: parsedMail}, <span class="string">"SMTPServer.onData.simpleParser: write HTML file"</span>);</span><br><span class="line">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;fs.<span class="title function_">writeFileSync</span>(session.<span class="property">id</span> + <span class="string">"/"</span> + session.<span class="property">id</span> + <span class="string">".html"</span>, parsedWithoutAttachments.<span class="property">html</span>);</span><br><span class="line">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;parsedMail.<span class="property">attachments</span>.<span class="title function_">forEach</span>(<span class="function"><span class="params">attachment</span> =&gt;</span> {</span><br><span class="line">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; logger.<span class="title function_">info</span>({<span class="attr">sessionInfo</span>: session, <span class="attr">parsedMailInfo</span>: parsedMail}, <span class="string">"SMTPServer.onData.simpleParser: write attachment: "</span> + attachment.<span class="property">filename</span>);</span><br><span class="line">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fs.<span class="title function_">writeFileSync</span>(session.<span class="property">id</span> + <span class="string">"/"</span> + attachment.<span class="property">filename</span>, attachment.<span class="property">content</span>);</span><br><span class="line">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;});</span><br><span class="line"></span><br><span class="line">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="comment">// publish sessionId via MQTT</span></span><br><span class="line">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="keyword">if</span> (mqttClientConnected) {</span><br><span class="line">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="keyword">let</span> topic = <span class="string">"/"</span> + session.<span class="property">clientHostname</span>;</span><br><span class="line">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="keyword">let</span> playload = <span class="title class_">JSON</span>.<span class="title function_">stringify</span>({<span class="attr">topic</span>: topic, <span class="attr">sessionId</span>: session.<span class="property">id</span>});</span><br><span class="line">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; logger.<span class="title function_">info</span>({<span class="attr">topic</span>: topic, <span class="attr">payload</span>: playload }, <span class="string">"Publish to MQTT with topic "</span> + topic);</span><br><span class="line">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mqttClient.<span class="title function_">publish</span>(topic, <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(playload));</span><br><span class="line">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;}</span><br><span class="line"></span><br><span class="line">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;logger.<span class="title function_">info</span>({<span class="attr">sessionInfo</span>: session, <span class="attr">parsedMailInfo</span>: parsedMail}, <span class="string">"SMTPServer.onData.simpleParser: done"</span>);</span><br><span class="line">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="title function_">callback</span>();</span><br><span class="line">&nbsp; &nbsp; &nbsp; });</span><br><span class="line"></span><br><span class="line">&nbsp; &nbsp; &nbsp; logger.<span class="title function_">info</span>({<span class="attr">sessionInfo</span>: session}, <span class="string">"SMTPServer.onData: done"</span>);</span><br><span class="line">&nbsp; &nbsp;},</span><br><span class="line"></span><br><span class="line">&nbsp; &nbsp;<span class="title function_">onAuth</span>(<span class="params">auth, session, callback</span>) {</span><br><span class="line">&nbsp; &nbsp; &nbsp; logger.<span class="title function_">info</span>({<span class="attr">sessionInfo</span>: session}, <span class="string">"SMTPServer.onAuth"</span>);</span><br><span class="line">&nbsp; &nbsp; &nbsp; <span class="keyword">if</span> (auth.<span class="property">username</span> !== smtpUserName &amp;&amp; auth.<span class="property">password</span> !== smtpPassword) {</span><br><span class="line">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="keyword">return</span> <span class="title function_">callback</span>(<span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">"Invalid username/password:"</span> + auth.<span class="property">username</span> + <span class="string">"/"</span> + auth.<span class="property">password</span>));</span><br><span class="line">&nbsp; &nbsp; &nbsp; }</span><br><span class="line">&nbsp; &nbsp; &nbsp; <span class="title function_">callback</span>(<span class="literal">null</span>, { <span class="attr">user</span>: <span class="number">123456</span> }); <span class="comment">// where 123 is the user id or similar property</span></span><br><span class="line">&nbsp; &nbsp;}</span><br><span class="line">});</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">smtpServer.<span class="title function_">on</span>(<span class="string">"error"</span>, <span class="function"><span class="params">err</span> =&gt;</span> {</span><br><span class="line">&nbsp; &nbsp;logger.<span class="title function_">error</span>(<span class="string">"Error %s"</span>, err.<span class="property">message</span>);</span><br><span class="line">});</span><br><span class="line"></span><br><span class="line">process.<span class="title function_">chdir</span>(smtpStorage);</span><br><span class="line"></span><br><span class="line">mqttClient.<span class="title function_">on</span>(<span class="string">"connect"</span>, <span class="function">() =&gt;</span> {</span><br><span class="line">&nbsp; &nbsp;mqttClientConnected = <span class="literal">true</span>;</span><br><span class="line">&nbsp; &nbsp;logger.<span class="title function_">info</span>(<span class="string">"Connected to MQTT Broker"</span>);</span><br><span class="line">});</span><br><span class="line"></span><br><span class="line">mqttClient.<span class="title function_">on</span>(<span class="string">"error"</span>, <span class="keyword">function</span> (<span class="params">error</span>) {</span><br><span class="line">&nbsp; &nbsp;logger.<span class="title function_">error</span>(<span class="string">"Error connecting to MQTT Broker, Error:"</span> + error);</span><br><span class="line">&nbsp; &nbsp;process.<span class="title function_">exit</span>(<span class="number">1</span>);</span><br><span class="line">});</span><br><span class="line"></span><br><span class="line">logger.<span class="title function_">info</span>({}, <span class="string">"Startup SMTP Server"</span>);</span><br><span class="line">smtpServer.<span class="title function_">listen</span>(smtpServerPort, <span class="string">"0.0.0.0"</span>);</span><br></pre></td></tr></tbody></table></figure>

<h1 id="Create-new-user-smtp2mqtt"><a href="#Create-new-user-smtp2mqtt" class="headerlink" title="Create new user smtp2mqtt"></a>Create new user smtp2mqtt</h1><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo useradd -m smtp2mqtt</span><br></pre></td></tr></tbody></table></figure>

<h1 id="Add-user-smtp2mqtt-to-docker-group"><a href="#Add-user-smtp2mqtt-to-docker-group" class="headerlink" title="Add user smtp2mqtt to docker group"></a>Add user smtp2mqtt to docker group</h1><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo usermod -aG docker smtp2mqtt</span><br></pre></td></tr></tbody></table></figure>

<h1 id="Login-as-user-smtp2mqtt"><a href="#Login-as-user-smtp2mqtt" class="headerlink" title="Login as user smtp2mqtt"></a>Login as user smtp2mqtt</h1><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo -u smtp2mqtt -i</span><br></pre></td></tr></tbody></table></figure>

<h1 id="Get-uid-and-gid-for-user-smtp2mqtt"><a href="#Get-uid-and-gid-for-user-smtp2mqtt" class="headerlink" title="Get uid and gid for user smtp2mqtt"></a>Get uid and gid for user smtp2mqtt</h1><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">smtp2mqtt@docker:~ $ <span class="built_in">id</span></span><br><span class="line">uid=1014(smtp2mqtt) gid=1014(smtp2mqtt) <span class="built_in">groups</span>=1014(smtp2mqtt),995(docker)</span><br></pre></td></tr></tbody></table></figure>

<h1 id="Create-directories-for-smtp2mqtt"><a href="#Create-directories-for-smtp2mqtt" class="headerlink" title="Create directories for smtp2mqtt"></a>Create directories for smtp2mqtt</h1><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> storage</span><br></pre></td></tr></tbody></table></figure>

<h1 id="File-docker-compose-yaml"><a href="#File-docker-compose-yaml" class="headerlink" title="File docker-compose.yaml"></a>File docker-compose.yaml</h1><figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">"3.5"</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">smtp2mqtt:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">smtp2mqtt:latest</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">smtp2mqtt</span></span><br><span class="line">    <span class="attr">user:</span> <span class="number">1009</span><span class="string">:995</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/home/smtp2mqtt/storage:/storage:rw</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">"2525:2525"</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">influxdb2</span></span><br><span class="line"></span><br><span class="line"><span class="attr">networks:</span></span><br><span class="line">    <span class="attr">influxdb2:</span></span><br><span class="line">        <span class="attr">external:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">"influxdb2"</span></span><br></pre></td></tr></tbody></table></figure>

         </div>
         <!-- right side bar-->
         <div class="fl w-100 w-20-l pl1-ns mb4">

            <!-- Widget 1: Tags -->
            
            <x_partial_widget_tags_ejs>
  <div class="">
    <h2>Tags</h2>
    
    <p>
      <a class="fw3 ph1 dib" href="/tags/Docker/">Docker</a>
    </p>
    
    <p>
      <a class="fw3 ph1 dib" href="/tags/MQTT/">MQTT</a>
    </p>
    
    <p>
      <a class="fw3 ph1 dib" href="/tags/NodeJS/">NodeJS</a>
    </p>
    
    <p>
      <a class="fw3 ph1 dib" href="/tags/ExpressJS/">ExpressJS</a>
    </p>
    
    <p>
      <a class="fw3 ph1 dib" href="/tags/Typescript/">Typescript</a>
    </p>
    
    <p>
      <a class="fw3 ph1 dib" href="/tags/Dockerfile/">Dockerfile</a>
    </p>
    
  </div>
</x_partial_widget_tags_ejs>
            
         </div>
      </div>
   </div>
</x_post_ejs>

    <x_partial_footer_ejs>
   <div class="fixed db w-100 tc tr-l bg-1 bottom-0">
      <a class="link dim f6 f5-l dib mr3 mr4-l white" href="/admin/datenschutzerklaerung.html" title="Datenschutzerklärung">
         Datenschutzerklärung
      </a>
      <a class="link dim f6 f5-l dib mr3 mr4-l white" href="/admin/impressum.html" title="Impressum">
         Impressum
      </a>
   </div>
</x_partial_footer_ejs>

  

  
</x_layout_ejs"></body><script src="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.0/cookieconsent.min.js"></script><script>window.addEventListener("load", function(){window.cookieconsent.initialise({"theme":"classic","position":"bottom","static":true,"cookie":{"expiryDays":7},"content":{"message":"This website uses cookies to ensure you get the best experience on our website. Who doesn't like cookies?","dismiss":"Feed me"}})});</script></html>