<html lang="en"><head><link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.0/cookieconsent.min.css"></head><body><x_layout_ejs">
  
  

  <x_partial_head_ejs>
   
      <meta charset="utf-8">
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <meta name="viewport" content="width=device-width, initial-scale=1">

      <!-- Tachyons Core CSS -->
      <link rel="stylesheet" href="https://unpkg.com/tachyons@4.12.0/css/tachyons.min.css">

      <!-- Custom Fonts -->
      <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">

      <!-- Custom CSS -->
      
<link rel="stylesheet" href="/css/style.css">

   <meta name="generator" content="Hexo 6.3.0">
</x_partial_head_ejs>


  

    <x_post_ejs>
   <!-- Banner -->
   <x_partial_banner_ejs>
   <div class="w-100 bg-banner ph5-ns ph3 text-light mb4">

      <nav class="db dt-l w-100 mw10 center border-box pv3">
         <div class="db dtc-l v-mid w-100 w-75-l tc tr-l">
            
            <a class="link dim f6 f5-l dib mr3 mr4-l white" href="/" title="Home">
               Home
            </a>
            
         </div>
      </nav>

      <!-- Title -->
      <div class="w-100 mw10 center vh-20 dt">
         <div class="dtc v-mid white">
            <h1 class="f1-l f2-m tc tc-m tl-ns mv0">My Digital Garden</h1>
            <p class="ma0 pb3 f4 fw3 tc tc-m tl-ns">Digital Garden of Horst Fleischer</p>
         </div>
      </div>
   </div>
</x_partial_banner_ejs>

   <!-- Content -->
   <div class="w-100 ph2 ph4-m ph5-l">
      <div class="content">
         <div class="fl w-100 w-80-l mw9 left pr4-ns pr0-m mb4 br-l b--light-gray post-content">
            <h1>
               Installation eines Kubernetes Clusters mit Vagrant
            </h1>
            <div>
               Vagrant Skript um einen Kubernetes Cluster mit 4 Knoten (1 Master und 3 Worker) und NFS Server (Shared Storage) aufzusetzen.
            </div>

            <!-- TOC -->
            <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Quellen"><span class="toc-number">1.</span> <span class="toc-text">Quellen</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Netzwerk"><span class="toc-number">2.</span> <span class="toc-text">Netzwerk</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Skripte"><span class="toc-number">3.</span> <span class="toc-text">Skripte</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Vagrantfile"><span class="toc-number">3.1.</span> <span class="toc-text">Vagrantfile</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#provision-nfsserver-sh"><span class="toc-number">3.2.</span> <span class="toc-text">provision_nfsserver.sh</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#provision-kubernetes-sh"><span class="toc-number">3.3.</span> <span class="toc-text">provision_kubernetes.sh</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#provision-master-sh"><span class="toc-number">3.4.</span> <span class="toc-text">provision_master.sh</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#provision-node-sh"><span class="toc-number">3.5.</span> <span class="toc-text">provision_node.sh</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#provision-metallb-sh"><span class="toc-number">3.6.</span> <span class="toc-text">provision_metallb.sh</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#provision-metallb-sh-1"><span class="toc-number">3.7.</span> <span class="toc-text">provision_metallb.sh</span></a></li></ol></li></ol>

            <!-- Main Post Content -->
            <h2 id="Quellen"><a href="#Quellen" class="headerlink" title="Quellen"></a>Quellen</h2><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/fleishor/VagrantKubernetesCluster/tree/master/Kubernetes">Github</a></li>
<li><a target="_blank" rel="noopener" href="https://ugurakgul.medium.com/creating-a-local-kubernetes-cluster-with-vagrant-ba591ab70ee2">Creating a Local Kubernetes Cluster with Vagrant</a></li>
<li><a target="_blank" rel="noopener" href="https://gist.github.com/danielepolencic/ef4ddb763fd9a18bf2f1eaaa2e337544">3 Virtual Machines Kubernetes cluster</a></li>
</ul>
<h2 id="Netzwerk"><a href="#Netzwerk" class="headerlink" title="Netzwerk"></a>Netzwerk</h2><p><img src="/2023/12/15/Installation-eines-Kubernetes-Cluster-mit-Vagrant/vagrant-kubernetes-netzwerk.drawio.png" alt="Kubernetes Netzwerk"></p>
<h2 id="Skripte"><a href="#Skripte" class="headerlink" title="Skripte"></a>Skripte</h2><h3 id="Vagrantfile"><a href="#Vagrantfile" class="headerlink" title="Vagrantfile"></a>Vagrantfile</h3><!-- https://raw.githubusercontent.com/fleishor/VagrantKubernetesCluster/master/Kubernetes/Vagrantfile -->
<figure class="highlight ruby"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Set IP Adresses of Master and Worker nodes</span></span><br><span class="line"><span class="variable constant_">ADMIN_IP</span>        = <span class="string">"192.168.56.8"</span></span><br><span class="line"><span class="variable constant_">NFSSERVER_IP</span>    = <span class="string">"192.168.56.9"</span></span><br><span class="line"><span class="variable constant_">MASTER_IP</span>       = <span class="string">"192.168.56.10"</span></span><br><span class="line"><span class="variable constant_">NODE_01_IP</span>      = <span class="string">"192.168.56.11"</span></span><br><span class="line"><span class="variable constant_">NODE_02_IP</span>      = <span class="string">"192.168.56.12"</span></span><br><span class="line"><span class="variable constant_">NODE_03_IP</span>      = <span class="string">"192.168.56.13"</span></span><br><span class="line"></span><br><span class="line"><span class="title class_">Vagrant</span>.configure(<span class="string">"2"</span>) <span class="keyword">do</span> |<span class="params">config</span>|</span><br><span class="line">  config.vm.box = <span class="string">"fleishor/ubuntu2204-2023-12-01"</span></span><br><span class="line">  config.vm.box_check_update = <span class="literal">false</span></span><br><span class="line">  config.vm.synced_folder <span class="string">"."</span>, <span class="string">"/vagrant"</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># disable vbguest additions</span></span><br><span class="line">  <span class="keyword">if</span> <span class="title class_">Vagrant</span>.has_plugin?(<span class="string">"vagrant-vbguest"</span>)</span><br><span class="line">    config.vbguest.auto_update = <span class="literal">false</span> </span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># use proxy at host machine</span></span><br><span class="line">  <span class="keyword">if</span> <span class="title class_">Vagrant</span>.has_plugin?(<span class="string">"vagrant-proxyconf"</span>)</span><br><span class="line">    config.apt_proxy.http = <span class="string">"http://desktop.fritz.box:3142"</span></span><br><span class="line">    config.apt_proxy.https = <span class="string">"DIRECT"</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># define cpu/memory of nodes</span></span><br><span class="line">  nodes = [</span><br><span class="line">    { <span class="symbol">:name</span> =&gt; <span class="string">"admin"</span>,     <span class="symbol">:ip</span> =&gt; <span class="variable constant_">ADMIN_IP</span>,     <span class="symbol">:cpus</span> =&gt; <span class="number">2</span>, <span class="symbol">:memory</span> =&gt; <span class="number">2096</span>, <span class="symbol">:disksize</span> =&gt; <span class="string">"32GB"</span> },</span><br><span class="line">    { <span class="symbol">:name</span> =&gt; <span class="string">"nfsserver"</span>, <span class="symbol">:ip</span> =&gt; <span class="variable constant_">NFSSERVER_IP</span>, <span class="symbol">:cpus</span> =&gt; <span class="number">2</span>, <span class="symbol">:memory</span> =&gt; <span class="number">2096</span>, <span class="symbol">:disksize</span> =&gt; <span class="string">"32GB"</span> },</span><br><span class="line">    { <span class="symbol">:name</span> =&gt; <span class="string">"master"</span>,    <span class="symbol">:ip</span> =&gt; <span class="variable constant_">MASTER_IP</span>,    <span class="symbol">:cpus</span> =&gt; <span class="number">2</span>, <span class="symbol">:memory</span> =&gt; <span class="number">4096</span>, <span class="symbol">:disksize</span> =&gt; <span class="string">"32GB"</span> },</span><br><span class="line">    { <span class="symbol">:name</span> =&gt; <span class="string">"node-01"</span>,   <span class="symbol">:ip</span> =&gt; <span class="variable constant_">NODE_01_IP</span>,   <span class="symbol">:cpus</span> =&gt; <span class="number">2</span>, <span class="symbol">:memory</span> =&gt; <span class="number">4096</span>, <span class="symbol">:disksize</span> =&gt; <span class="string">"32GB"</span> },</span><br><span class="line">    { <span class="symbol">:name</span> =&gt; <span class="string">"node-02"</span>,   <span class="symbol">:ip</span> =&gt; <span class="variable constant_">NODE_02_IP</span>,   <span class="symbol">:cpus</span> =&gt; <span class="number">2</span>, <span class="symbol">:memory</span> =&gt; <span class="number">4096</span>, <span class="symbol">:disksize</span> =&gt; <span class="string">"32GB"</span> },</span><br><span class="line">    { <span class="symbol">:name</span> =&gt; <span class="string">"node-03"</span>,   <span class="symbol">:ip</span> =&gt; <span class="variable constant_">NODE_03_IP</span>,   <span class="symbol">:cpus</span> =&gt; <span class="number">2</span>, <span class="symbol">:memory</span> =&gt; <span class="number">4096</span>, <span class="symbol">:disksize</span> =&gt; <span class="string">"32GB"</span> },</span><br><span class="line">  ]</span><br><span class="line"></span><br><span class="line">  <span class="comment"># create virtual machine</span></span><br><span class="line">  nodes.each <span class="keyword">do</span> |<span class="params">opts</span>|</span><br><span class="line">    config.vm.define opts[<span class="symbol">:name</span>] <span class="keyword">do</span> |<span class="params">node</span>|</span><br><span class="line">      node.vm.hostname = opts[<span class="symbol">:name</span>]</span><br><span class="line">      node.vm.network <span class="string">"private_network"</span>, <span class="symbol">ip:</span> opts[<span class="symbol">:ip</span>]</span><br><span class="line"><span class="comment">#      node.vm.disk :disk, size: opts[:disksize], primary: true</span></span><br><span class="line"></span><br><span class="line">      node.vm.provider <span class="string">"virtualbox"</span> <span class="keyword">do</span> |<span class="params">vb</span>|</span><br><span class="line">        vb.name = opts[<span class="symbol">:name</span>]</span><br><span class="line">        vb.cpus = opts[<span class="symbol">:cpus</span>]</span><br><span class="line">        vb.memory = opts[<span class="symbol">:memory</span>]</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">      <span class="comment"># special provision for admin</span></span><br><span class="line">      <span class="keyword">if</span> node.vm.hostname == <span class="string">"admin"</span> <span class="keyword">then</span> </span><br><span class="line">        node.vm.provision <span class="string">"shell"</span>, <span class="symbol">path:</span><span class="string">"./provision_admin.sh"</span></span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">      </span><br><span class="line">      <span class="comment"># special provision for nfsserver</span></span><br><span class="line">      <span class="keyword">if</span> node.vm.hostname == <span class="string">"nfsserver"</span> <span class="keyword">then</span> </span><br><span class="line">        node.vm.provision <span class="string">"shell"</span>, <span class="symbol">path:</span><span class="string">"./provision_nfsserver.sh"</span></span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">      </span><br><span class="line">      <span class="comment"># special provision for master</span></span><br><span class="line">      <span class="keyword">if</span> node.vm.hostname == <span class="string">"master"</span> <span class="keyword">then</span> </span><br><span class="line">        node.vm.provision <span class="string">"shell"</span>, <span class="symbol">path:</span><span class="string">"./provision_kubernetes.sh"</span></span><br><span class="line">        node.vm.provision <span class="string">"shell"</span>, <span class="symbol">path:</span><span class="string">"./provision_master.sh"</span></span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">      <span class="comment"># special provision for worker nodes</span></span><br><span class="line">      <span class="keyword">if</span> node.vm.hostname =~ <span class="regexp">/node-[0-9]*/</span> <span class="keyword">then</span></span><br><span class="line">        node.vm.provision <span class="string">"shell"</span>, <span class="symbol">path:</span><span class="string">"./provision_kubernetes.sh"</span></span><br><span class="line">        node.vm.provision <span class="string">"shell"</span>, <span class="symbol">path:</span><span class="string">"./provision_node.sh"</span></span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></tbody></table></figure>

<h3 id="provision-nfsserver-sh"><a href="#provision-nfsserver-sh" class="headerlink" title="provision_nfsserver.sh"></a>provision_nfsserver.sh</h3><!-- https://raw.githubusercontent.com/fleishor/VagrantKubernetesCluster/master/Kubernetes/provision_nfsserver.sh -->
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash -e</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"--------------------------------------------------------------------------------"</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"Install NFS server"</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"--------------------------------------------------------------------------------"</span></span><br><span class="line">sudo apt-get update -y</span><br><span class="line">sudo apt-get install -y nfs-kernel-server</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"--------------------------------------------------------------------------------"</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"Create NFS share"</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"--------------------------------------------------------------------------------"</span></span><br><span class="line">sudo <span class="built_in">mkdir</span> -p /mnt/nfs_share</span><br><span class="line">sudo <span class="built_in">chown</span> -R nobody:nogroup /mnt/nfs_share/</span><br><span class="line">sudo <span class="built_in">chmod</span> 777 /mnt/nfs_share/</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"--------------------------------------------------------------------------------"</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"Export NFS share"</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"--------------------------------------------------------------------------------"</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"/mnt/nfs_share 192.168.56.9/24(rw,sync,no_subtree_check,no_root_squash)"</span> &gt;&gt; /etc/exports</span><br><span class="line">sudo exportfs -a</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"--------------------------------------------------------------------------------"</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"Restart NFS server"</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"--------------------------------------------------------------------------------"</span></span><br><span class="line">sudo systemctl restart nfs-kernel-server</span><br></pre></td></tr></tbody></table></figure>

<h3 id="provision-kubernetes-sh"><a href="#provision-kubernetes-sh" class="headerlink" title="provision_kubernetes.sh"></a>provision_kubernetes.sh</h3><!-- https://raw.githubusercontent.com/fleishor/VagrantKubernetesCluster/master/Kubernetes/provision_kubernetes.sh -->
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash -e</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"--------------------------------------------------------------------------------"</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"Install containerd"</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"--------------------------------------------------------------------------------"</span></span><br><span class="line">sudo apt-get update -y</span><br><span class="line">sudo apt-get install -y nfs-common</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"--------------------------------------------------------------------------------"</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"Install containerd"</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"--------------------------------------------------------------------------------"</span></span><br><span class="line">sudo apt-get update -y</span><br><span class="line">sudo apt-get install -y containerd</span><br><span class="line">sudo <span class="built_in">mkdir</span> -p /etc/containerd</span><br><span class="line">containerd config default | sudo <span class="built_in">tee</span> /etc/containerd/config.toml</span><br><span class="line">sudo sed -i <span class="string">'s/SystemdCgroup = false/SystemdCgroup = true/'</span> /etc/containerd/config.toml</span><br><span class="line">sudo systemctl daemon-reload </span><br><span class="line">sudo systemctl restart containerd</span><br><span class="line">sudo systemctl <span class="built_in">enable</span> containerd</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"--------------------------------------------------------------------------------"</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"Install Kubernetes"</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"--------------------------------------------------------------------------------"</span></span><br><span class="line">sudo apt-get update -y</span><br><span class="line">sudo apt-get install -y ca-certificates curl</span><br><span class="line">curl -fsSL http://packages.cloud.google.com/apt/doc/apt-key.gpg | sudo gpg --dearmor -o /etc/apt/keyrings/kubernetes-archive-keyring.gpg</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"deb [signed-by=/etc/apt/keyrings/kubernetes-archive-keyring.gpg] http://apt.kubernetes.io/ kubernetes-xenial main"</span> | sudo <span class="built_in">tee</span> /etc/apt/sources.list.d/kubernetes.list</span><br><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install -y kubelet kubeadm kubectl kubernetes-cni</span><br><span class="line">sudo apt-mark hold kubelet kubeadm kubectl</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"--------------------------------------------------------------------------------"</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"Mount NFS share"</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"--------------------------------------------------------------------------------"</span></span><br><span class="line"><span class="built_in">mkdir</span> /mnt/nfs_share</span><br><span class="line">sudo mount nfsserver:/mnt/nfs_share /mnt/nfs_share</span><br></pre></td></tr></tbody></table></figure>

<h3 id="provision-master-sh"><a href="#provision-master-sh" class="headerlink" title="provision_master.sh"></a>provision_master.sh</h3><!-- https://raw.githubusercontent.com/fleishor/VagrantKubernetesCluster/master/Kubernetes/provision_master.sh -->
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash -e</span></span><br><span class="line"></span><br><span class="line">master_node=192.168.56.10</span><br><span class="line">pod_network_cidr=10.244.0.0/16</span><br><span class="line">node_name=$(hostname -s)</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"--------------------------------------------------------------------------------"</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"Start kubernetes services"</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"--------------------------------------------------------------------------------"</span></span><br><span class="line">sudo systemctl <span class="built_in">enable</span> kubelet</span><br><span class="line">sudo systemctl start kubelet</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"--------------------------------------------------------------------------------"</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"Download kubernetes images"</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"--------------------------------------------------------------------------------"</span></span><br><span class="line">sudo kubeadm config images pull</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"--------------------------------------------------------------------------------"</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"Initialize kubernetes"</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"--------------------------------------------------------------------------------"</span></span><br><span class="line">sudo kubeadm init --apiserver-advertise-address=<span class="variable">$master_node</span> --apiserver-cert-extra-sans=<span class="variable">$master_node</span> --pod-network-cidr=<span class="variable">$pod_network_cidr</span> --node-name <span class="variable">$node_name</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"--------------------------------------------------------------------------------"</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"Wait 60s"</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"--------------------------------------------------------------------------------"</span></span><br><span class="line"><span class="built_in">sleep</span> 60</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"--------------------------------------------------------------------------------"</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"Copy kubernetes config file to shared folder /vagrant/admin.conf"</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"--------------------------------------------------------------------------------"</span></span><br><span class="line">sudo <span class="built_in">cp</span> -f /etc/kubernetes/admin.conf /vagrant/admin.conf</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"--------------------------------------------------------------------------------"</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"Copy kubernetes config file from shared folder to /root/.kube"</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"--------------------------------------------------------------------------------"</span></span><br><span class="line"><span class="built_in">mkdir</span> -p /root/.kube</span><br><span class="line">sudo <span class="built_in">cp</span> -f /vagrant/admin.conf /root/.kube/config</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"--------------------------------------------------------------------------------"</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"Copy kubernetes config file from shared folder to /home/vagrant/.kube"</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"--------------------------------------------------------------------------------"</span></span><br><span class="line"><span class="built_in">mkdir</span> -p /home/vagrant/.kube</span><br><span class="line">sudo <span class="built_in">cp</span> -f /vagrant/admin.conf /home/vagrant/.kube/config</span><br><span class="line">sudo <span class="built_in">chown</span> 1000:1000 /home/vagrant/.kube/config</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"--------------------------------------------------------------------------------"</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"Generate join command"</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"--------------------------------------------------------------------------------"</span></span><br><span class="line">kubeadm token create --print-join-command | <span class="built_in">tee</span> /vagrant/join_command.sh</span><br><span class="line"><span class="built_in">chmod</span> +x /vagrant/join_command.sh</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"--------------------------------------------------------------------------------"</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"Install flannel network"</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"--------------------------------------------------------------------------------"</span></span><br><span class="line">kubectl apply -f /vagrant/flannel.yaml</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"--------------------------------------------------------------------------------"</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"Install HELM"</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"--------------------------------------------------------------------------------"</span></span><br><span class="line">curl http://baltocdn.com/helm/signing.asc | gpg --dearmor | sudo <span class="built_in">tee</span> /usr/share/keyrings/helm.gpg &gt; /dev/null</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"deb [arch=<span class="subst">$(dpkg --print-architecture)</span> signed-by=/usr/share/keyrings/helm.gpg] http://baltocdn.com/helm/stable/debian/ all main"</span> | sudo <span class="built_in">tee</span> /etc/apt/sources.list.d/helm-stable-debian.list</span><br><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install helm</span><br></pre></td></tr></tbody></table></figure>

<h3 id="provision-node-sh"><a href="#provision-node-sh" class="headerlink" title="provision_node.sh"></a>provision_node.sh</h3><!-- https://raw.githubusercontent.com/fleishor/VagrantKubernetesCluster/master/Kubernetes/provision_node.sh -->
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash -e</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"--------------------------------------------------------------------------------"</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"Copy kubernetes config file from shared folder to /root/.kube"</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"--------------------------------------------------------------------------------"</span></span><br><span class="line"><span class="built_in">mkdir</span> -p /root/.kube</span><br><span class="line">sudo <span class="built_in">cp</span> -f /vagrant/admin.conf /root/.kube/config</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"--------------------------------------------------------------------------------"</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"Copy kubernetes config file from shared folder to /home/vagrant/.kube"</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"--------------------------------------------------------------------------------"</span></span><br><span class="line"><span class="built_in">mkdir</span> -p /home/vagrant/.kube</span><br><span class="line">sudo <span class="built_in">cp</span> -f /vagrant/admin.conf /home/vagrant/.kube/config</span><br><span class="line">sudo <span class="built_in">chown</span> 1000:1000 /home/vagrant/.kube/config</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"--------------------------------------------------------------------------------"</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"Join worker node to kubernetes cluster"</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"--------------------------------------------------------------------------------"</span></span><br><span class="line">sudo /vagrant/join_command.sh</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"--------------------------------------------------------------------------------"</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"Set worker node name in kubernetes cluster"</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"--------------------------------------------------------------------------------"</span></span><br><span class="line"><span class="built_in">whoami</span></span><br><span class="line">kubectl label node $(hostname -s) node-role.kubernetes.io/worker=worker</span><br></pre></td></tr></tbody></table></figure>

<h3 id="provision-metallb-sh"><a href="#provision-metallb-sh" class="headerlink" title="provision_metallb.sh"></a>provision_metallb.sh</h3><!-- https://raw.githubusercontent.com/fleishor/VagrantKubernetesCluster/master/Kubernetes/provision_metallb.sh -->
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">"--------------------------------------------------------------------------------"</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"Install metallb"</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"--------------------------------------------------------------------------------"</span></span><br><span class="line"><span class="comment"># https://github.com/metallb/metallb/issues/1540</span></span><br><span class="line"><span class="comment"># Update failurePolicy=Ignore for rule ValidatingWebhookConfiguration for metallb-webhook-configuration</span></span><br><span class="line">kubectl apply -f /vagrant/metallb-native.yaml</span><br><span class="line">kubectl create secret generic -n metallb-system memberlist --from-literal=secretkey=<span class="string">"<span class="subst">$(openssl rand -base64 128)</span>"</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"--------------------------------------------------------------------------------"</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"Create configuration for metallb"</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"--------------------------------------------------------------------------------"</span></span><br><span class="line">kubectl apply -f /vagrant/metallb-configuration.yaml</span><br></pre></td></tr></tbody></table></figure>

<h3 id="provision-metallb-sh-1"><a href="#provision-metallb-sh-1" class="headerlink" title="provision_metallb.sh"></a>provision_metallb.sh</h3><!-- https://raw.githubusercontent.com/fleishor/VagrantKubernetesCluster/master/Kubernetes/provision_prometheus.sh -->
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">helm repo add prometheus-community https://prometheus-community.github.io/helm-charts</span><br><span class="line">helm repo add stable https://charts.helm.sh/stable</span><br><span class="line"></span><br><span class="line">kubectl create namespace prometheus</span><br><span class="line">helm install prometheus-community/kube-prometheus-stack --generate-name --namespace prometheus</span><br></pre></td></tr></tbody></table></figure>

         </div>
         <!-- right side bar-->
         <div class="fl w-100 w-20-l pl1-ns mb4">

            <!-- Widget 1: Tags -->
            
            <x_partial_widget_tags_ejs>
  <div class="">
    <h2>Tags</h2>
    
    <p>
      <a class="fw3 ph1 dib" href="/tags/Kubernetes/">Kubernetes</a>
    </p>
    
    <p>
      <a class="fw3 ph1 dib" href="/tags/Vagrant/">Vagrant</a>
    </p>
    
  </div>
</x_partial_widget_tags_ejs>
            

            <!-- Widget 2: ExternalLinks -->
            
   
         </div>
      </div>
   </div>
</x_post_ejs>

    <x_partial_footer_ejs>
   <div class="fixed db w-100 tc tr-l bg-1 bottom-0">
      <a class="link dim f6 f5-l dib mr3 mr4-l white" href="/admin/datenschutzerklaerung.html" title="Datenschutzerklärung">
         Datenschutzerklärung
      </a>
      <a class="link dim f6 f5-l dib mr3 mr4-l white" href="/admin/impressum.html" title="Impressum">
         Impressum
      </a>
   </div>
</x_partial_footer_ejs>

  

  
</x_layout_ejs"></body><script src="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.0/cookieconsent.min.js"></script><script>window.addEventListener("load", function(){window.cookieconsent.initialise({"theme":"classic","position":"bottom","static":true,"cookie":{"expiryDays":7},"content":{"message":"This website uses cookies to ensure you get the best experience on our website. Who doesn't like cookies?","dismiss":"Feed me"}})});</script></html>